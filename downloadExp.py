import os,os.path
import sys
import requests
import re
import threading
import wget

def printAuth():
	print("""
                                                                                                                        
          @@@@@@@@@@@@                @@@@@@@@@@@@@@                @@@@@@@@@@@@@@@@                @@@@@@@@@@@@        
        @@@@@@@@  @@@@@@              @@@@@@  @@@@@@                @@@@      @@@@@@              @@@@@@  @@@@@@@@      
      @@@@@@@@        @@              @@@@@@    @@@@                @@      @@@@@@              @@@@@@      @@@@@@@@    
      @@@@@@          @@                @@@@@@    @@                      @@@@@@                @@@@          @@@@@@    
      @@@@@@                              @@@@@@@@                      @@@@@@@@                @@@@          @@@@@@    
      @@@@@@                                @@@@@@@@                    @@@@@@                  @@@@          @@@@@@    
      @@@@@@                          @@@@    @@@@@@                  @@@@@@                    @@@@          @@@@@@    
        @@@@@@        @@              @@@@      @@@@                @@@@@@        @@            @@@@@@      @@@@@@      
        @@@@@@@@@@@@@@@@              @@@@@@@@@@@@@@              @@@@@@@@      @@@@              @@@@@@@@@@@@@@        
            @@@@@@@@@@                @@@@@@@@@@@@@@              @@@@@@@@@@@@@@@@@@                @@@@@@@@@@          
                                                                                                        @@@@@@@@        
                                                                                                              @@@@      
                                                                                                                        """)
rfd = r"CVE-EXP.txt"
wfd = r"CVE-EXP-DB.txt"
urlCVE = r"https://cve.mitre.org/cgi-bin/cvename.cgi?name="
patternEXPURL = r"https://www.exploit-db.com/exploits/"
patternEXPFILE = r"https://www.exploit-db.com/download/"
headers = {'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:61.0) Gecko/20100101'}

mutexRead = threading.Lock()
mutexWrite = threading.Lock()
rfd = open(rfd,"r")
wfd = open(wfd,"w")

def mkdir(path):
	folder = os.path.exists(path)
	if not folder:                   
		os.makedirs(path)



def searchThread():
	print("SearchThread Start");
	while 1:
		if mutexRead.acquire(10):
			cveNum = rfd.readline()
			mutexRead.release()
			if cveNum == "":
				print("SearchThread Exit");
				quit()
		else:
			print("mutexRead time out and Exit");
			quit()

		print("Current CVE: " + cveNum[:-2])
		print("requesting " + urlCVE + cveNum[:-2] + "...")
		req = requests.get(urlCVE + cveNum, headers=headers)
		expdbUrl = re.search(patternEXPURL + r"(\d)+", req.text)
		print("request finish...")
		
		if expdbUrl != None:
			print("requesting " + expdbUrl.group(0) + "...")
			req = requests.get(expdbUrl.group(0),headers=headers)
			print("request finish...")
			
			expFileUrl = re.search(patternEXPFILE + """\w+.\w+""", req.text)
			print(expFileUrl.group(0))
			if mutexWrite.acquire(10):
				wfd.write(expFileUrl.group(0)+"\r\n");
				mutexWrite.release()
			else:
				print("mutexWrite time out and Exit");
				quit()
			'''
			saveFileName = re.search("""\w+.\w+$""", expFileUrl.group(0))
			mkdir(cveNum[:-2])
			folder = os.path.exists(cveNum[:-2] + """/""" + saveFileName.group(0))
			if not folder:
				wget.download(expFileUrl.group(0), cveNum[:-2] + """/""" + saveFileName.group(0))
				print("");
			'''
				
if __name__ == "__main__":
	printAuth()
	print("Start...")
	t = []
	
	for i in range(10):
		t.append(threading.Thread(target=searchThread, name='searchThread'))
		t[i].start()
	
	for i in range(10):
		t[i].join()
		
	print("Finish...")
	rfd.close()
